---
title: "DS6306 Case Study 1"
author: "Rick Fontenot"
date: "12/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

For this case study we assume that our audience is the CEO and CFO of Budweiser (our client) and that they only have had one class in statistics. They have hired us to answer 7 questions and beyond those general questions we will speculate / anticipate what may be of interest to them.

We will start by importing the following data for analysis:

Beers.csv:
Name: Name of the beer.
Beer_ID: Unique identifier of the beer.
ABV: Alcohol by volume of the beer.
IBU: International Bitterness Units of the beer.
Brewery_ID: Brewery id associated with the beer.
Style: Style of the beer.
Ounces: Ounces of beer.

Breweries.csv:
Brew_ID: Unique identifier of the brewery.
Name: Name of the brewery.
City: City where the brewery is located.
State: U.S. State where the brewery is located.

```{r}
library(dplyr)
library(tidyverse)


beers = read.csv("https://raw.githubusercontent.com/rickfontenot/DS6306_Study1/main/Beers.csv", header = TRUE)

breweries = read.csv("https://raw.githubusercontent.com/rickfontenot/DS6306_Study1/main/Breweries.csv", header = TRUE)


head(beers)
head(breweries)

#install.packages("visdat")
library(visdat)
vis_dat(beers, warn_large_data=FALSE)
vis_dat(breweries, warn_large_data=FALSE)

dim(beers) #2410 observations x 7 columns
dim(breweries) #558 observations x 4 columns

sum(is.na(beers$Brewery_id)) #there are no missing values on the merge var
sum(is.na(breweries$Brew_ID)) #there are no missing values on the merge var

beers <- beers %>% rename(Beer_Name = Name) #both dataframes have "Name"
breweries <- breweries %>% rename(Brewery_Name = Name)

beerbrew <- merge(beers,breweries, by.x = "Brewery_id", by.y = "Brew_ID")
head(beerbrew)
 
head(beerbrew,6)
tail(beerbrew,6) # added to complete Question 2

beerbrew["Class"] <- ifelse(str_detect(beerbrew$Style,"IPA"),"IPA", ifelse(str_detect(beerbrew$Style,"Ale"),"Ale", ifelse(str_detect(beerbrew$Style,"Lager"),"Lager", ifelse(str_detect(beerbrew$Style,"Stout"),"Stout", ifelse(str_detect(beerbrew$Style,"Pilsner"),"Pilsner", ifelse(str_detect(beerbrew$Style,"Pilsener"),"Pilsner", ifelse(str_detect(beerbrew$Style,"Porter"),"Porter", ifelse(str_detect(beerbrew$Style,"APA"),"APA", ifelse(str_detect(beerbrew$Style,"Cider"),"Cider", ifelse(str_detect(beerbrew$Style,"Witbier"),"Witbier", ifelse(str_detect(beerbrew$Style,"Kölsch"),"Kölsch", ifelse(str_detect(beerbrew$Style,"Fruit"),"Fruit", ifelse(str_detect(beerbrew$Style,"Hefeweizen"),"Hefeweizen", ifelse(str_detect(beerbrew$Style,"Oktoberfest"),"Oktoberfest", ifelse(str_detect(beerbrew$Style,"Bitter"),"Bitter",
"Other")))))))))))))))

beerbrew %>%ggplot(aes(x = Class)) + geom_bar() +
ggtitle("Distribution of Styles") + coord_flip() + xlab("Style") + ylab("Count")

library(GGally)
beerbrew %>% select(ABV, IBU, Class) %>% ggpairs(aes(color=Class))

beerbrew %>% ggplot(mapping=aes(y=IBU, x=ABV,color=Class)) + geom_point(size=0.5, position="jitter")+ geom_smooth(method="lm",se=FALSE,size=1)+ labs(title="Correlation between ABV and IBU")
```


```{r, Joe's EDA}
#Joe EDA plotting on a map. 
#install.packages('usmap')
library(usmap)
```


```{r, Joe's EDA, Question 1}
#Question 1 How many Breweries are in each state

#table of number of Breweries by state
st.brew <- table(beerbrew$State)

#visualize that table
beerbrew %>% ggplot(aes(x=State),color=State) + 
  geom_histogram(binwidth = 5, stat="count") +
  theme(axis.text.x=element_text(angle=45,size = rel(.8), 
        margin = margin(.05, unit = "cm"),vjust =.5))
```


```{r, Joe's EDA, Question 3}
#Question 3 Address Missing values in each col

colSums(is.na(beerbrew))

#ABV has 62 missing values
#IBU has 1005 missing values 2410 total 
#no other NAs found
#it is likely that different state differ on their requirement to track IBU and ABV to operate within that state.
```


```{r, Joe's EDA, Compute Median by state ABV and IBU}
#Question 4 compute median median abv and ibu
#i'm making the choice to omit given 1005 or 2410 na values

st.ibu <- aggregate(IBU~State, data =  beerbrew, median, na.action=na.omit)
st.ibu

###visualize the state IBU median
st.ibu %>% ggplot(aes(x=State,y=IBU, fill=IBU)) + scale_fill_distiller(palette='Spectral') + geom_bar(stat = "identity") +
  theme(axis.text.x=element_text(angle=45,size = rel(.8), 
        margin = margin(.05, unit = "cm"),vjust =.5, hjust = 1))


#by date median ABV omitted na values
#Here it is practical to impute the missing values
st.abv <- aggregate(ABV~State, data = beerbrew, median, na.action = na.omit)
st.abv

#visualize the state abv medians
st.abv %>% ggplot(aes(x=State,y=ABV, fill=ABV)) + scale_fill_distiller(palette='Spectral') + geom_bar(stat = "identity") +
  theme(axis.text.x=element_text(angle=45,size = rel(.8), 
        margin = margin(.05, unit = "cm"),vjust =.5, hjust = 1))

#x is a table filtered for the missing abv values.
x <- beerbrew[!complete.cases(beerbrew$ABV),]

```
```{r Joe's EDA, Question 5 which state has the highest abv /ibu}

max.abv <- max(beerbrew$ABV,na.rm = T)
max.abv

max.ibu <- max(beerbrew$IBU, na.rm = T)
max.ibu

 

```

```{r Joe's EDA, Question 6 Comment on summary statistics distribution of ABV variable}


summary(beerbrew$ABV)

#Distribution of ABV Variable 
beerbrew %>% select(ABV) %>% ggplot(mapping=aes(x= ABV)) +
  geom_histogram(bins = 50) 

# Compare by State 
beerbrew %>% select(ABV, State) %>% ggplot(mapping=aes(x=ABV)) +
  geom_histogram(bins = 50) + facet_wrap(~State)
  

```

```{r Jason's EDA, Question 6 Start of Density plot by Beer Class}
p <- ggplot(beerbrew, aes(x=ABV)) + 
  geom_density()
p
```



```{r Joe's EDA, Question 7, Is there a relations between IBU and ABV}

beerbrew %>% ggplot(mapping=aes(y=IBU, x=ABV)) + geom_point()+
  geom_point(position=position_jitter(width=0.01),alpha=0.5)+
  geom_smooth(method="lm",se=FALSE,size=2)+
  labs(title="Correlation between ABV and IBU")


# correlation test

IbuAbv.cor <- cor.test(beerbrew$IBU,beerbrew$ABV, method= 'pearson')
IbuAbv.cor # cor test result 0.6706

```


```{r Jason's EDA, Question 7, Is there a relations between IBU and ABV}
library(ggpubr)
#7 Scatter Plot
#Feel free to remove

r_test = cor.test(beerbrew$IBU, beerbrew$ABV)
r_test

beerbrew.mod <- lm(IBU ~ ABV, data = beerbrew) 
summary(beerbrew.mod)

ggscatter(beerbrew, x = "IBU", y = "ABV", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "IBU", ylab = "ABV") +
  theme_economist()
```

```{r Jason's EDA, Question 8, KNN}
library(caret)
library(e1071)
library(class)
#Start of KNN
#Work in progress

# Filter out any beer style that is not an IPA or an Ale.
beers_IPAALE <- filter(beerbrew,grepl('IPA|Ale',Style))
beers_IPAALE <- beers_IPAALE[,-8]
# Create a new data frame that only holds the ABV,IBU, and beer style.
beers_IPAALE_sub <- select(beers_IPAALE,ABV,IBU,Style)
beers_IPAALE_sub$Style <- as.character(beers_IPAALE_sub$Style)

# Normalize the Beer styles to IPA or ALE
# This loop is used to iterate through each row and then to normalize the styles to simply say IPA or Ale.

for (i in 1:1534) {
  if (is.na(str_match(beers_IPAALE_sub[i,3],".Ale"))) {
    beers_IPAALE_sub[i,3] <- "IPA"
  } else {
    beers_IPAALE_sub[i,3] <- "ALE" 
    
  }
}


set.seed(877)
splitpale = .70
beerbrewsample <- sample(1:dim(beers_IPAALE_sub)[1],round(splitpale * dim(beers_IPAALE_sub)[1]))


# Test and Training with 70/30 split
knn_train <- beers_IPAALE_sub[beerbrewsample,]
knn_test <- beers_IPAALE_sub[-beerbrewsample,]

knn_train = na.omit(knn_train)
knn_test = na.omit(knn_test)

#md.pattern(knn_train)



# Using only the IBU and ABV values from both the training and test sets
# I use the beer style as the class against which the knn will search.
knnbeer <- knn(knn_train[,1:2],knn_test[,1:2],cl=knn_train$Style,k=24,prob = TRUE)
# The confusion matrix is used for calibrating the output of a model and examining all possible outcomes of the predictions
ipamatrix <- confusionMatrix(table(knnbeer,knn_test$Style))
ipamatrix

```


```{r}
beerbrew %>%ggplot(aes(x = Brewery_id)) + geom_bar() +
ggtitle("Distribution of Styles") + coord_flip() + xlab("Brewery ID") + ylab("Count")

brewsize <- beerbrew %>% count(Brewery_id)

beerbrewsize <- merge(brewsize,beerbrew, by.x = "Brewery_id", by.y = "Brewery_id")
head(beerbrewsize)

beerbrewsize %>%ggplot(aes(x = n, color=Class)) + geom_bar() +
ggtitle("Distribution of Styles") + xlab("#Beers per brewery") + ylab("Count")

```


US Map exercise


```{r}
library(maps)
install.packages("mapproj")
library(mapproj)

lookup = data.frame(abb = state.abb, State = state.name) #makes a data frame with State name and abbreviation.

BreweryMapData = breweries %>% count(State) #count up the breweries of each state.

colnames(BreweryMapData)[2] = "num_breweries" #change "n" to "num_breweries"
colnames(BreweryMapData)[1] = "abb" #change for merge
BreweryMapData$abb <- trimws(BreweryMapData$abb)
BreweryMapData <- BreweryMapData %>% filter(abb!='DC')

BreweryMapData = merge(BreweryMapData,lookup,"abb")
colnames(BreweryMapData)[3] = "region" #change for merge
BreweryMapData$region <- tolower(BreweryMapData$region)

states <- map_data("state")

map.df <- merge(states,BreweryMapData, by="region", all.x=T)
map.df <- map.df[order(map.df$order),]

ggplot(map.df, aes(x=long,y=lat,group=group))+
  geom_polygon(aes(fill=num_breweries))+
  geom_path()+ 
  scale_fill_gradientn(colours=rev(heat.colors(10)),na.value="grey90")+ggtitle("Number of Breweries by State")+
coord_map()

```